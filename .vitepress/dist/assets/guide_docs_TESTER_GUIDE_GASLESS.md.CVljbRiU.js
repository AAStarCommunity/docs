import{_ as i,c as a,o as e,ag as t}from"./chunks/framework.dvv-DFtf.js";const c=JSON.parse('{"title":"Paymaster V4 Gasless Test Guide","description":"","frontmatter":{},"headers":[],"relativePath":"guide/docs/TESTER_GUIDE_GASLESS.md","filePath":"guide/docs/TESTER_GUIDE_GASLESS.md","lastUpdated":null}'),n={name:"guide/docs/TESTER_GUIDE_GASLESS.md"};function l(p,s,h,r,k,o){return e(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="paymaster-v4-gasless-test-guide" tabindex="-1">Paymaster V4 Gasless Test Guide <a class="header-anchor" href="#paymaster-v4-gasless-test-guide" aria-label="Permalink to &quot;Paymaster V4 Gasless Test Guide&quot;">​</a></h1><blockquote><p>For external testers to run a gasless UserOperation on Sepolia.</p></blockquote><hr><h2 id="pre-configured-test-accounts" tabindex="-1">Pre-configured Test Accounts <a class="header-anchor" href="#pre-configured-test-accounts" aria-label="Permalink to &quot;Pre-configured Test Accounts&quot;">​</a></h2><p>Test accounts are dynamically configured via <code>l4-setup.ts</code> and stored in <code>scripts/l4-state.json</code>.</p><p>Key test personas:</p><ul><li><strong>Jason</strong>: Uses PaymasterV4, Token: aPNTs</li><li><strong>Bob</strong>: Uses PaymasterV4, Token: bPNTs</li><li><strong>Anni</strong>: Uses SuperPaymaster, Token: dPNTs</li><li><strong>Charlie</strong>: Uses PaymasterV4, Token: cPNTs</li></ul><p>Run <code>pnpm tsx scripts/l4-setup.ts</code> to view current addresses and status.</p><hr><h2 id="sdk-readiness-preparation-new" tabindex="-1">SDK Readiness &amp; Preparation (NEW) <a class="header-anchor" href="#sdk-readiness-preparation-new" aria-label="Permalink to &quot;SDK Readiness &amp; Preparation (NEW)&quot;">​</a></h2><p>The SDK now provides a &quot;One-Click&quot; readiness check to avoid common Bundler rejections.</p><h3 id="_1-check-readiness-diagnostic" tabindex="-1">1. Check Readiness (Diagnostic) <a class="header-anchor" href="#_1-check-readiness-diagnostic" aria-label="Permalink to &quot;1. Check Readiness (Diagnostic)&quot;">​</a></h3><p>Check if the Paymaster is staked, price is set, and user has deposit.</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { PaymasterOperator } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@aastar/paymaster&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> report</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterOperator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">checkGaslessReadiness</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    publicClient,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    entryPoint,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    paymasterAddress,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    userAA,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    tokenAddress</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">report.isReady) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Issues found:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, report.issues);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="_2-auto-prepare-operator-only" tabindex="-1">2. Auto-Prepare (Operator Only) <a class="header-anchor" href="#_2-auto-prepare-operator-only" aria-label="Permalink to &quot;2. Auto-Prepare (Operator Only)&quot;">​</a></h3><p>Automatically fix missing stake, deposit, or prices.</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> steps</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterOperator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prepareGaslessEnvironment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    operatorWallet,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    publicClient,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    entryPoint,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    paymasterAddress,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    tokenAddress,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        tokenPriceUSD: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">100000000</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">n</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// $1.00 (8 decimals)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        minStake: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseEther</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0.05&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Reduced from 0.2 ETH</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        minDeposit: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseEther</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0.1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Minimum deposit required</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Steps taken:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, steps);</span></span></code></pre></div><hr><h2 id="price-management-apis-for-operators" tabindex="-1">Price Management APIs (For Operators) <a class="header-anchor" href="#price-management-apis-for-operators" aria-label="Permalink to &quot;Price Management APIs (For Operators)&quot;">​</a></h2><p>The SDK provides these APIs in <code>PaymasterV4Client</code>:</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { PaymasterOperator } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@aastar/paymaster&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Write APIs (owner/operator only)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterOperator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">updatePrice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(walletClient, paymasterAddress);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterOperator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">setTokenPrice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(walletClient, paymasterAddress, tokenAddress, priceUSD);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Read APIs (anyone) - also available in PaymasterOperator for convenience</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">price</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">updatedAt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterOperator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getCachedPrice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(publicClient, paymasterAddress);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> tokenPrice</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterOperator.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTokenPrice</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(publicClient, paymasterAddress, tokenAddress);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 4. Instant Bill (via TxHash) - No scanning required</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fee</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getTransactionFee</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(publicClient, txHash, paymasterAddress);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Cost: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fee</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tokenCost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} dPNTs\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><hr><h2 id="zero-friction-workflow-simplified" tabindex="-1">Zero-Friction Workflow (Simplified) <a class="header-anchor" href="#zero-friction-workflow-simplified" aria-label="Permalink to &quot;Zero-Friction Workflow (Simplified)&quot;">​</a></h2><p>For a streamlined experience, we provide ready-to-use scripts for both <strong>Admin</strong> (Environment Setup) and <strong>Developer</strong> (Transaction Submission).</p><h3 id="_1-admin-devops-one-click-preparation" tabindex="-1">1. Admin / DevOps: One-Click Preparation <a class="header-anchor" href="#_1-admin-devops-one-click-preparation" aria-label="Permalink to &quot;1. Admin / DevOps: One-Click Preparation&quot;">​</a></h3><p>Ensure the Paymaster environment is fully ready (Staked, Funded, Priced).</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Checks 7+ readiness criteria and fixes them automatically</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tsx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> examples/prepare-gasless.ts</span></span></code></pre></div><p><strong>What it does:</strong></p><ul><li>Checks EntryPoint Stake &amp; Deposit</li><li>verifying Oracle ETH/USD price</li><li>Checks Token Support &amp; Price</li><li>Auto-seeds user deposit if low</li></ul><h3 id="_2-app-developer-one-liner-submission-code-walkthrough" tabindex="-1">2. App Developer: One-Liner Submission (Code Walkthrough) <a class="header-anchor" href="#_2-app-developer-one-liner-submission-code-walkthrough" aria-label="Permalink to &quot;2. App Developer: One-Liner Submission (Code Walkthrough)&quot;">​</a></h3><p>To understand how to integrate Gasless features into your app, look at <code>examples/simple-gasless-demo.ts</code>. This script demonstrates the &quot;Zero-Friction&quot; Developer Experience (DX).</p><p><strong>Reference Script</strong>: <a href="../examples/simple-gasless-demo.ts"><code>examples/simple-gasless-demo.ts</code></a></p><h4 id="step-1-setup-client-wallet" tabindex="-1">Step 1: Setup Client &amp; Wallet <a class="header-anchor" href="#step-1-setup-client-wallet" aria-label="Permalink to &quot;Step 1: Setup Client &amp; Wallet&quot;">​</a></h4><p>Standard <code>viem</code> setup. You need a <code>WalletClient</code> (to sign the UserOp) and a <code>PublicClient</code> (to read data).</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 1. Setup Clients</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> wallet</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createWalletClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ account, chain: sepolia, transport: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rpcUrl) });</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> client</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createPublicClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ chain: sepolia, transport: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rpcUrl) });</span></span></code></pre></div><h4 id="step-2-define-user-intent-calldata" tabindex="-1">Step 2: Define &quot;User Intent&quot; (CallData) <a class="header-anchor" href="#step-2-define-user-intent-calldata" aria-label="Permalink to &quot;Step 2: Define &quot;User Intent&quot; (CallData)&quot;">​</a></h4><p>Instead of dealing with raw ABI encoding, use the SDK&#39;s semantic builders.</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2A. Inner Action: Transfer 0.01 dPNTs</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> innerCall</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encodeTokenTransfer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(recipient, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseEther</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0.01&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 2B. Outer Action: Execute via AA</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> callData</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">encodeExecution</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    tokenAddress, </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">n</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    innerCall</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="step-3-✨-the-magic-line-submission-✨" tabindex="-1">Step 3: ✨ The Magic Line (Submission) ✨ <a class="header-anchor" href="#step-3-✨-the-magic-line-submission-✨" aria-label="Permalink to &quot;Step 3: ✨ The Magic Line (Submission) ✨&quot;">​</a></h4><p>This is the core of the SDK. The <code>submitGaslessUserOperation</code> function handles all the complexity of Account Abstraction:</p><ol><li><strong>Gas Estimation</strong>: Automatically calls the Bundler to estimate usage.</li><li><strong>Dynamic Gas Pricing</strong>: Fetches current network gas prices and applies 1.5x buffer for volatility (no hardcoded values).</li><li><strong>Efficiency Guard</strong>: Applies optimized gas limits (no buffer for verification, 1.1x for execution) to pass strict Bundler rules.</li><li><strong>Data Encoding</strong>: Packs the Paymaster data (time validity, deposit info).</li><li><strong>Signing</strong>: Signs the UserOp with the user&#39;s private key (v0.7 compliant).</li><li><strong>Submission</strong>: Sends the packet to the Bundler.</li></ol><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 3. Submit Gasless UserOp (One-Liner)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// No need to specify gas prices - SDK auto-fetches from network!</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> userOpHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">submitGaslessUserOperation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    client,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Public Client for reads</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    wallet,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Wallet Client for signing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    aaAccountAddress,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// The User&#39;s AA Wallet Address</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    entryPointAddress, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Global EntryPoint</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    paymasterAddress,  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// The Paymaster paying the fees</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    tokenAddress,      </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// The Token the user is &quot;spending&quot; (conceptually)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    bundlerUrl,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Where to send the UserOp</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    callData           </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// The action from Step 2</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Optional: Pass custom gas prices via options if needed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="step-4-wait-for-receipt" tabindex="-1">Step 4: Wait for Receipt <a class="header-anchor" href="#step-4-wait-for-receipt" aria-label="Permalink to &quot;Step 4: Wait for Receipt&quot;">​</a></h4><p>The <code>userOpHash</code> is just a tracking ID. You must wait for the Bundler to bundle it into a real Ethereum Transaction.</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 4. Wait for Execution</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> receipt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bundlerClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">waitForUserOperationReceipt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    hash: userOpHash </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`mined in tx: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">receipt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">receipt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">transactionHash</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="step-5-instant-bill-get-cost" tabindex="-1">Step 5: Instant Bill (Get Cost) <a class="header-anchor" href="#step-5-instant-bill-get-cost" aria-label="Permalink to &quot;Step 5: Instant Bill (Get Cost)&quot;">​</a></h4><p>Since the fee is deducted from an internal Paymaster balance (not an external ERC-20 transfer), users might wonder &quot;How much did I pay?&quot;. The <code>getTransactionFee</code> helper instantly decodes the <code>PostOpProcessed</code> log from the receipt to give you the exact cost.</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 5. Instant Bill (No scanning required)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> feeInfo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getFeeFromReceipt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(receipt.receipt, paymasterAddress);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`[Instant Bill] Cost: \${</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">formatEther</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">feeInfo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tokenCost</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">} dPNTs\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><hr><hr><h2 id="advanced-remote-signing-kms-mpc" tabindex="-1">Advanced: Remote Signing (KMS / MPC) <a class="header-anchor" href="#advanced-remote-signing-kms-mpc" aria-label="Permalink to &quot;Advanced: Remote Signing (KMS / MPC)&quot;">​</a></h2><p>If your AA Account&#39;s private key is stored in a KMS (AWS, Google) or MPC Node, you cannot export it. <strong>Good news</strong>: The SDK is compatible with any signer.</p><p><strong>How to integrate:</strong></p><ol><li>Create a custom <code>viem</code> Account that calls your KMS.</li><li>Pass this account to <code>createWalletClient</code>.</li><li>The SDK uses <code>wallet.account.signMessage(...)</code> internally.</li></ol><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Example: Custom KMS Account</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { toAccount } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;viem/accounts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> kmsAccount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> toAccount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    address: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0xYourAAAddress&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> signMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 1. Send &#39;message.raw&#39; (the UserOpHash) to your KMS API</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> signature</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> myKmsClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message.raw); </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // 2. Return the signature</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> signature; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Implement other required methods (signTransaction, etc.) if needed</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> wallet</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createWalletClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ account: kmsAccount, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Now just call the SDK as normal!</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PaymasterClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">submitGaslessUserOperation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, wallet, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><hr><hr><h2 id="superpaymaster-integration-credit-based-gasless" tabindex="-1">SuperPaymaster Integration (Credit-Based Gasless) <a class="header-anchor" href="#superpaymaster-integration-credit-based-gasless" aria-label="Permalink to &quot;SuperPaymaster Integration (Credit-Based Gasless)&quot;">​</a></h2><p>SuperPaymaster allows users to pay gas using credits provided by an <strong>Operator</strong>. This model is ideal for ecosystem projects where a central entity (the Operator) sponsors transactions for its users.</p><h3 id="_1-the-superpaymaster-flow" tabindex="-1">1. The SuperPaymaster Flow <a class="header-anchor" href="#_1-the-superpaymaster-flow" aria-label="Permalink to &quot;1. The SuperPaymaster Flow&quot;">​</a></h3><ol><li><strong>Operator Config</strong>: An Operator (e.g., Anni) configures a credit line in the SuperPaymaster contract.</li><li><strong>User Action</strong>: A user (UserOp Sender) initiates a transaction.</li><li><strong>Submission</strong>: The app submits the UserOp specifying the <code>operator</code> address.</li><li><strong>Execution</strong>: SuperPaymaster verifies the Operator&#39;s credit and sponsors the gas.</li></ol><h3 id="_2-developer-workflow" tabindex="-1">2. Developer Workflow <a class="header-anchor" href="#_2-developer-workflow" aria-label="Permalink to &quot;2. Developer Workflow&quot;">​</a></h3><p>We provide a dedicated <code>SuperPaymasterClient</code> that abstracts gas estimation and operator data packing.</p><p><strong>Reference Script</strong>: <a href="../examples/simple-superpaymaster-demo.ts"><code>examples/simple-superpaymaster-demo.ts</code></a></p><h4 id="step-1-configure-app-operator" tabindex="-1">Step 1: Configure App &amp; Operator <a class="header-anchor" href="#step-1-configure-app-operator" aria-label="Permalink to &quot;Step 1: Configure App &amp; Operator&quot;">​</a></h4><p>You need the <strong>User&#39;s</strong> account (Signer) and the <strong>Operator&#39;s</strong> address.</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { SuperPaymasterClient } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@aastar/paymaster&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> APP_CONFIG</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    superPaymaster: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0x...&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Contract Address</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    operator: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0x...&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,             </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Operator Address (Provider)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    token: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0x...&#39;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                 // Logic Token (optional context)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><h4 id="step-2-submit-with-dynamic-gas-tuning" tabindex="-1">Step 2: Submit with Dynamic Gas Tuning <a class="header-anchor" href="#step-2-submit-with-dynamic-gas-tuning" aria-label="Permalink to &quot;Step 2: Submit with Dynamic Gas Tuning&quot;">​</a></h4><p>The <code>SuperPaymasterClient.submitGaslessTransaction</code> method automatically:</p><ul><li><strong>Estimates Gas</strong>: Queries the Bundler.</li><li><strong>Tunes Limits</strong>: Adjusts <code>verificationGasLimit</code> to satisfy Bundler efficiency rules (&gt; 0.4 ratio) while ensuring safe execution for Paymaster logic.</li><li><strong>Packs Data</strong>: Encodes the Operator address into the <code>paymasterAndData</code> field.</li></ul><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> userOpHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SuperPaymasterClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">submitGaslessTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    client,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Public Client</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    wallet,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Wallet (Signer - Local or KMS)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    userAA,            </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// User&#39;s AA Address</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    entryPoint,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// EntryPoint Address</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    bundlerUrl,        </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Bundler RPC</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        token: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APP_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.token,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        recipient: recipientAddress,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        amount: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseEther</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        operator: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APP_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.operator,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        paymasterAddress: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">APP_CONFIG</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.superPaymaster</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="_3-using-kms-mpc-signers" tabindex="-1">3. Using KMS / MPC Signers <a class="header-anchor" href="#_3-using-kms-mpc-signers" aria-label="Permalink to &quot;3. Using KMS / MPC Signers&quot;">​</a></h3><p>Just like the standard Paymaster usage, <code>SuperPaymasterClient</code> supports any <code>viem</code> Wallet Client.</p><p>If your User keys are in a KMS (AWS, Google, Fireblocks):</p><ol><li>Create a custom <code>viem</code> Account that forwards <code>signMessage</code> calls to your KMS.</li><li>Pass this account to <code>createWalletClient</code>.</li><li>Pass the <code>wallet</code> to <code>SuperPaymasterClient</code>.</li></ol><p><em>(See &quot;Advanced: Remote Signing&quot; section above for code example).</em></p><hr><hr><hr><h2 id="automated-faucet-verification-script-new" tabindex="-1">Automated Faucet &amp; Verification Script (New) <a class="header-anchor" href="#automated-faucet-verification-script-new" aria-label="Permalink to &quot;Automated Faucet &amp; Verification Script (New)&quot;">​</a></h2><p>We have implemented a <strong>SepoliaFaucetAPI</strong> that automates the tedious setup process for new test accounts (Funding ETH, Registering EndUser, Minting Tokens, Depositing to Paymaster).</p><h3 id="verification-script" tabindex="-1">Verification Script <a class="header-anchor" href="#verification-script" aria-label="Permalink to &quot;Verification Script&quot;">​</a></h3><p>Run the following script to create a fresh AA account, fund it, and execute a gasless transaction immediately:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tsx</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> scripts/test-faucet-and-gasless.ts</span></span></code></pre></div><p><strong>What it does:</strong></p><ol><li><strong>Identity</strong>: Generates a random private key (Brand new user).</li><li><strong>Faucet</strong>: Uses <code>SepoliaFaucetAPI.prepareTestAccount</code> to: <ul><li>Fund 0.02 ETH (if needed).</li><li>Register <code>ENDUSER</code> role (attempts via Admin key; logs warning if no permission).</li><li>Mint <code>cPNTs</code> tokens (for SuperPaymaster).</li><li>Deposit tokens to Paymaster V4 (if needed).</li></ul></li><li><strong>Action</strong>: Calculates the AA address (undeployed).</li><li><strong>Submission</strong>: Uses <code>SuperPaymasterClient</code> (with factory support) to deploy and execute a gasless transaction in one step.</li></ol><blockquote><p><strong>Note</strong>: Requires <code>PRIVATE_KEY</code> (Deployer) or <code>PRIVATE_KEY_ANNI</code> in <code>.env.sepolia</code> to have Admin/Minter privileges. If specific permissions fail (like GrantRole), the script attempts to proceed.</p></blockquote><h3 id="_4-code-sample-using-faucet-kms" tabindex="-1">4. Code Sample: Using Faucet &amp; KMS <a class="header-anchor" href="#_4-code-sample-using-faucet-kms" aria-label="Permalink to &quot;4. Code Sample: Using Faucet &amp; KMS&quot;">​</a></h3><p>For a complete example of how to combine the Faucet (for setup) and a Mock KMS (for signing), refer to <code>scripts/test-kms-gasless.ts</code>.</p><h4 id="faucet-setup-one-time" tabindex="-1">Faucet Setup (One-Time) <a class="header-anchor" href="#faucet-setup-one-time" aria-label="Permalink to &quot;Faucet Setup (One-Time)&quot;">​</a></h4><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { SepoliaFaucetAPI } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;@aastar/core&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SepoliaFaucetAPI.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prepareTestAccount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    adminWallet, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// WalletClient with Admin Key</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    publicClient,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        targetAA: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0x...&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        token: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0x...&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,       </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// GToken Address</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        registry: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0x...&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,    </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Registry Address</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Optional:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        tokenAmount: </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">parseEther</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;1000&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h4 id="kms-remote-signer-integration" tabindex="-1">KMS / Remote Signer Integration <a class="header-anchor" href="#kms-remote-signer-integration" aria-label="Permalink to &quot;KMS / Remote Signer Integration&quot;">​</a></h4><p>To use a remote signer (AWS KMS, Fireblocks, MPC), creates a custom <code>viem</code> account.</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { toAccount } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;viem/accounts&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> remoteSigner</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> toAccount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    address: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;0xYourWalletAddress&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> signMessage</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // message.raw is the UserOpHash</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sig</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> myKmsClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sign</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(message.raw); </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Ensure signature is valid 65-byte hex (r, s, v)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sig; </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    },</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> signTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">tx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Not supported for Gasless&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> wallet</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> createWalletClient</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">({ account: remoteSigner, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> });</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Pass this wallet to SuperPaymasterClient</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> userOpHash</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SuperPaymasterClient.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">submitGaslessTransaction</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, wallet, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><hr><h2 id="appendix-real-transaction-analysis" tabindex="-1">Appendix: Real Transaction Analysis <a class="header-anchor" href="#appendix-real-transaction-analysis" aria-label="Permalink to &quot;Appendix: Real Transaction Analysis&quot;">​</a></h2><p>Below is an analysis of a fulfilled Gasless Transaction (executed via <code>l4-test-jason1-gasless.ts</code> on Sepolia).</p><p><strong>Transaction Hash</strong>: <code>0xa3179a3464ac9d14681f051b9ea7f194834cfd9b65f6897415195a28656ce1cb</code><br><strong>Etherscan Link</strong>: <a href="https://sepolia.etherscan.io/tx/0xa3179a3464ac9d14681f051b9ea7f194834cfd9b65f6897415195a28656ce1cb" target="_blank" rel="noreferrer">View on Sepolia Etherscan</a></p><h3 id="data-breakdown" tabindex="-1">Data Breakdown <a class="header-anchor" href="#data-breakdown" aria-label="Permalink to &quot;Data Breakdown&quot;">​</a></h3><table tabindex="0"><thead><tr><th style="text-align:left;">Field</th><th style="text-align:left;">Value / Description</th><th style="text-align:left;">Interpretation</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Status</strong></td><td style="text-align:left;"><code>Success</code></td><td style="text-align:left;">The transaction was mined and executed successfully.</td></tr><tr><td style="text-align:left;"><strong>From</strong></td><td style="text-align:left;"><code>0x4a1627CACf9bFb16ed955738b9932d511644e489</code> (Bundler EOA)</td><td style="text-align:left;">The Bundler/Relayer that submitted the batch. This is NOT the user.</td></tr><tr><td style="text-align:left;"><strong>To</strong></td><td style="text-align:left;"><code>0x0000000071727De22E5E9d8BAf0edAc6f37da032</code> (EntryPoint v0.7)</td><td style="text-align:left;">The central EntryPoint contract that constructs and executes the AA call.</td></tr><tr><td style="text-align:left;"><strong>Transaction Action</strong></td><td style="text-align:left;">Transfer 0.1 dPNTs</td><td style="text-align:left;">The verified &quot;User Intent&quot;. The AA account successfully called the Token contract.</td></tr><tr><td style="text-align:left;"><strong>ERC-20 Tokens</strong></td><td style="text-align:left;"><code>0xECD9C07f648B09CFb78906302822Ec52Ab87dd70</code> (Jason AA1) → <code>0xEcAACb915f7D92e9916f449F7ad42BD0408733c9</code> (Anni)</td><td style="text-align:left;"><strong>The Core Action</strong>: Jason AA1 transferred 0.1 dPNTs to Anni.</td></tr><tr><td style="text-align:left;"><strong>Gas Usage</strong></td><td style="text-align:left;"><code>165,824</code> / <code>409,844</code> (40.46%)</td><td style="text-align:left;">The Paymaster sponsored the gas. The Bundler overestimated (Limit), but actual usage was fair.</td></tr><tr><td style="text-align:left;"><strong>Internal Txns</strong></td><td style="text-align:left;">Transfer 0.0000189 ETH (Refund)</td><td style="text-align:left;">The <strong>Paymaster</strong> (via EntryPoint) refunding the Bundler for the ETH gas cost.</td></tr><tr><td style="text-align:left;"><strong>Burnt Fees</strong></td><td style="text-align:left;"><code>0.00000000047...</code> ETH</td><td style="text-align:left;">The portion of the gas fee burnt by the network (EIP-1559).</td></tr></tbody></table><h3 id="key-takeaways" tabindex="-1">Key Takeaways <a class="header-anchor" href="#key-takeaways" aria-label="Permalink to &quot;Key Takeaways&quot;">​</a></h3><ol><li><strong>User Pays Zero ETH</strong>: The <code>From</code> address (Bundler) paid the ETH gas. The Internal Transaction shows the Bundler getting reimbursed.</li><li><strong>User Spent dPNTs</strong>: The <code>ERC-20 Token Transfer</code> shows the user moving <code>dPNTs</code>. This likely covers the service fee (gas + premium) in a real &quot;Pay with Token&quot; model, though in this &quot;Gasless&quot; mode, the dPNTs might just be the payload or a separate fee payment.</li></ol><h3 id="frequently-asked-questions-analysis" tabindex="-1">Frequently Asked Questions (Analysis) <a class="header-anchor" href="#frequently-asked-questions-analysis" aria-label="Permalink to &quot;Frequently Asked Questions (Analysis)&quot;">​</a></h3><h4 id="_1-why-is-from-the-bundler-not-the-user" tabindex="-1">1. Why is &quot;From&quot; the Bundler, not the User? <a class="header-anchor" href="#_1-why-is-from-the-bundler-not-the-user" aria-label="Permalink to &quot;1. Why is &quot;From&quot; the Bundler, not the User?&quot;">​</a></h4><p>In Account Abstraction (ERC-4337), the User does not send the transaction directly.</p><ul><li><strong>The Envelope</strong>: The Bundler (<code>0x4a16...</code>) sends the Ethereum Transaction to the <code>EntryPoint</code>. They pay the ETH gas.</li><li><strong>The Letter</strong>: The <code>EntryPoint</code> opens the envelope and executes your <strong>UserOperation</strong>.</li><li><strong>The Result</strong>: Etherscan shows the &quot;Envelope&quot; (Bundler -&gt; EntryPoint) as the top-level transaction. Your action (Token Transfer) is an <em>Internal Transaction</em> or <em>Log Event</em> triggered inside.</li></ul><h4 id="_2-where-is-the-gas-fee-value-0-eth" tabindex="-1">2. Where is the Gas Fee? &quot;Value: 0 ETH&quot;? <a class="header-anchor" href="#_2-where-is-the-gas-fee-value-0-eth" aria-label="Permalink to &quot;2. Where is the Gas Fee? &quot;Value: 0 ETH&quot;?&quot;">​</a></h4><ul><li>The <code>Transaction Fee</code> shown on Etherscan (e.g., 0.000016 ETH) is paid by the <strong>Bundler</strong>.</li><li>The <strong>Paymaster</strong> refunds the Bundler (visible in &quot;Internal Transactions&quot; as a transfer from Paymaster to Bundler).</li><li><strong>Your Cost (in Tokens)</strong>: Since this Paymaster uses a &quot;Deposit Model&quot;, the fee is deducted from your internal balance within the Paymaster contract. <ul><li><strong>Visibility</strong>: This deduction does NOT show up as an ERC-20 Transfer (because tokens didn&#39;t move wallets, only internal counters changed).</li><li><strong>Verification</strong>: Look at the <strong>Logs</strong> tab for the <code>PostOpProcessed</code> event. It explicitly lists <code>tokenCost</code> (the amount of dPNTs deducted).</li></ul></li></ul><h4 id="_3-why-is-there-only-one-erc-20-transfer" tabindex="-1">3. Why is there only one ERC-20 Transfer? <a class="header-anchor" href="#_3-why-is-there-only-one-erc-20-transfer" aria-label="Permalink to &quot;3. Why is there only one ERC-20 Transfer?&quot;">​</a></h4><ul><li>The transfer you see (<code>0.1 dPNTs</code> from Jason to Anni) is your <strong>Actual execution payload</strong>.</li><li>If the Paymaster used &quot;Token Paymaster Mode 1&quot; (pulling tokens from your wallet), you would see a second transfer for the fee.</li></ul><h4 id="_4-i-can-t-see-the-deducted-amount-how-to-read-logs" tabindex="-1">4. &quot;I can&#39;t see the Deducted Amount!&quot; (How to Read Logs) <a class="header-anchor" href="#_4-i-can-t-see-the-deducted-amount-how-to-read-logs" aria-label="Permalink to &quot;4. &quot;I can&#39;t see the Deducted Amount!&quot; (How to Read Logs)&quot;">​</a></h4><p>You mentioned you couldn&#39;t find the deduction. It is in <strong>Log Index 2</strong> (on Etherscan Logs tab).</p><ul><li><strong>Event Signature (Topic 0)</strong>: <code>0x62544d7f...</code> (<code>PostOpProcessed</code>).</li><li><strong>Data Field</strong>: Contains 3 values (32 bytes each). <ol><li><strong>ActualGasCost (ETH)</strong>: <code>0xc5ba77775be</code> -&gt; <code>0.00001358 ETH</code> (The actual reimbursed amount).</li><li><strong>TokenCost (dPNTs)</strong>: <code>0x99ffeb21efcb3b</code> -&gt; <code>43346900000000000</code> (Raw Units). <ul><li>Assuming 18 decimals: <strong>0.0433469 dPNTs</strong>.</li></ul></li><li><strong>ProtocolRevenue</strong>: Same as above (no markup in this test).</li></ol></li></ul><p><strong>Summary</strong>: Your deposit was deducted by <strong>0.0433 dPNTs</strong>.</p>`,114)])])}const g=i(n,[["render",l]]);export{c as __pageData,g as default};
